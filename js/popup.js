var getPageURL = function(url) {
    var urlInfo = new URL(url);
    var path = urlInfo.pathname;

    if (path === '') {
        path = '/';
    } else if (path.slice(-1) !== '/') {
        var lastSlash = path.lastIndexOf('/');
        path = path.substr(0, lastSlash + 1);
    }

    return urlInfo.protocol + '//' + urlInfo.hostname + path + '.git/';
};

var getHomeURL = function(url) {
    var urlInfo = new URL(url);
    return urlInfo.protocol + '//' + urlInfo.hostname + '/.git/';
};

var setResult = function(found, callbackId) {
    if (found) {
        $('#' + callbackId).html('<img src="img/error.png" title="This site has a .git folder &lt;-- SECURITY LEAK!">');
    } else {
        $('#' + callbackId).html('<img src="img/check.png" title="This site has no .git folder. Well done.">');
    }
};

var scanUrl = function(url, callbackId) {
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
        if (xhr.readyState == 4) {
            var found = xhr.status == 403;
            setResult(found, callbackId);
        }
    };
    xhr.open("GET", url, true);
    xhr.send();
};

var init = function(url) {
    var pageUrl = getPageURL(url);
    var homeUrl = getHomeURL(url);

    $('#url-home').text(homeUrl);
    $('#url-page').text(pageUrl);

    var checkPageUrl = homeUrl !== pageUrl;

    scanUrl(homeUrl, 'url-home-status');
    if (checkPageUrl) {
        $('#row-url-page').show();
        scanUrl(pageUrl, 'url-page-status');
    } else {
        $('#row-url-page').hide();
    }
};

document.addEventListener('DOMContentLoaded', function() {
    chrome.tabs.getSelected(null, function(tab) {
        init(tab.url);
    });
}, false);